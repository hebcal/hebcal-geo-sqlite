#!/usr/bin/env node

import {buildGeonamesSqlite} from '@hebcal/geo-sqlite';
import {pino} from 'pino';
import minimist from 'minimist';

const argv = minimist(process.argv.slice(2), {
  boolean: ['help', 'quiet'],
  string: ['population'],
  alias: {h: 'help', q: 'quiet'},
});

if (argv.help) {
  usage();
  process.exit(0);
}

const logger = pino({
  level: argv.quiet ? 'warn' : 'info',
  transport: {
    target: 'pino-pretty',
    options: {translateTime: 'SYS:standard', ignore: 'pid,hostname'},
  },
});

const args = argv._;
if (args.length !== 7) {
  usage();
  process.exit(1);
}

const options = {
  dbFilename: args[0],
  countryInfotxt: args[1],
  cities5000txt: args[2],
  citiesPatch: args[3],
  admin1CodesASCIItxt: args[4],
  ILtxt: args[5],
  ILalternate: args[6],
  logger: logger,
};
if (argv.population) {
  options.population = +argv.population;
}
buildGeonamesSqlite(options).then(() => {
  console.log('Done!');
});

function usage() {
  const infiles = 'countryInfo.txt cities5000.txt cities-patch.txt admin1CodesASCII.txt IL.txt IL-alternatenames.txt';
  console.log(`Usage: build-geonames-sqlite geonames.sqlite3 ${infiles}`);
}
